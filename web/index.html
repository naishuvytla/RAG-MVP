<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>rag-mvp</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // tailwind dark mode via class
    tailwind.config = { darkMode: 'class' };
    // set initial theme from localStorage or system
    (function() {
      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (saved ? saved === 'dark' : prefersDark) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    })();
  </script>
</head>
<body class="h-full bg-gradient-to-b from-gray-50 to-white dark:from-neutral-950 dark:to-neutral-900 text-gray-900 dark:text-neutral-100">
  <div class="min-h-full max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
    <!-- header -->
    <header class="mb-6 lg:mb-8 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl bg-indigo-600 dark:bg-indigo-500 text-white grid place-items-center font-semibold shadow-sm">R</div>
        <div>
          <h1 class="text-xl sm:text-2xl font-semibold tracking-tight">RAG MVP</h1>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="themeBtn" class="rounded-lg border border-gray-200 dark:border-neutral-700 px-3 py-1.5 text-sm hover:bg-gray-50 dark:hover:bg-neutral-800" title="toggle theme">Theme</button>
        <button id="healthBtn" class="rounded-lg border border-gray-200 dark:border-neutral-700 px-3 py-1.5 text-sm hover:bg-gray-50 dark:hover:bg-neutral-800">Health</button>
        <span id="health" class="text-xs sm:text-sm text-gray-600 dark:text-neutral-400"></span>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- left column: upload + docs -->
      <div class="lg:col-span-1 space-y-6">
        <!-- upload card -->
        <section class="bg-white dark:bg-neutral-900 rounded-2xl shadow-sm ring-1 ring-gray-200 dark:ring-neutral-800 p-5">
          <h2 class="text-base font-semibold mb-2">Upload papers</h2>
          <p class="text-sm text-gray-600 dark:text-neutral-400 mb-3">Add one or more PDFs. Weâ€™ll parse (GROBID), chunk, embed, and index them.</p>

          <!-- drag & drop zone -->
          <div id="dropZone" class="relative border-2 border-dashed rounded-xl p-5 text-center cursor-pointer transition
              border-gray-300 hover:border-indigo-400 dark:border-neutral-700 dark:hover:border-indigo-500">
            <input id="pdfs" type="file" accept="application/pdf" multiple class="absolute inset-0 opacity-0 cursor-pointer" />
            <div class="flex items-center justify-center gap-3 pointer-events-none">
              <div class="h-9 w-9 rounded-lg bg-indigo-600/10 text-indigo-600 dark:text-indigo-400 grid place-items-center">ðŸ“„</div>
              <div class="text-sm">
                <div class="font-medium">Drop PDFs here or click to browse</div>
                <div class="text-gray-500 dark:text-neutral-400">Max ~25â€“50MB each</div>
              </div>
            </div>
          </div>

          <!-- selected files display -->
          <div id="chosen" class="mt-2 text-xs text-gray-600 dark:text-neutral-400"></div>

          <div class="mt-3 flex items-center gap-2">
            <button id="upBtn" class="inline-flex items-center gap-2 rounded-xl bg-indigo-600 dark:bg-indigo-500 text-white px-3 py-2 text-sm font-medium hover:bg-indigo-700 dark:hover:bg-indigo-600 active:translate-y-px">
              <span>Upload & Index</span>
            </button>
            <div id="uploadHint" class="text-xs text-gray-500 dark:text-neutral-400">You can keep using the app while files process.</div>
          </div>

          <div id="jobs" class="mt-4 space-y-2"></div>
        </section>

        <!-- documents panel (read-only list of docs/ contents) -->
        <section class="bg-white dark:bg-neutral-900 rounded-2xl shadow-sm ring-1 ring-gray-200 dark:ring-neutral-800 p-5">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-base font-semibold">Documents</h3>
            <button id="refreshDocs" class="text-sm rounded-lg border px-2 py-1 hover:bg-gray-50 dark:hover:bg-neutral-800">Refresh</button>
          </div>
          <div id="docsEmpty" class="hidden text-sm text-gray-600 dark:text-neutral-400">
            No PDFs found in <code>docs/</code>. Upload some to get started.
          </div>
          <div id="docsList" class="divide-y divide-gray-200 dark:divide-neutral-800"></div>
        </section>
      </div>

      <!-- right column: ask + results -->
      <div class="lg:col-span-2 space-y-6">
        <!-- ask card -->
        <section class="bg-white dark:bg-neutral-900 rounded-2xl shadow-sm ring-1 ring-gray-200 dark:ring-neutral-800 p-5">
          <h2 class="text-base font-semibold mb-3">Ask a question</h2>

          <div class="space-y-3">
            <textarea id="q" rows="3" class="w-full rounded-xl border border-gray-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" placeholder="what are the main contributions of these papers?"></textarea>

            <div class="flex flex-wrap items-center gap-3">
              <label class="inline-flex items-center gap-2">
                <input id="useGen" type="checkbox" class="h-4 w-4 rounded border-gray-300 dark:border-neutral-700" checked />
                <span class="text-sm">Use Gemini for a written answer</span>
              </label>

              <div class="flex items-center gap-2">
                <span class="text-sm text-gray-600 dark:text-neutral-400">Top-K</span>
                <input id="k" type="number" min="6" max="100" value="40" class="w-20 rounded-lg border border-gray-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 p-1.5 text-sm"/>
              </div>

              <div class="flex items-center gap-2">
                <span class="text-sm text-gray-600 dark:text-neutral-400">Per-doc</span>
                <input id="perDoc" type="number" min="1" max="5" value="2" class="w-16 rounded-lg border border-gray-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 p-1.5 text-sm"/>
              </div>

              <button id="askBtn" class="ml-auto inline-flex items-center gap-2 rounded-xl bg-indigo-600 dark:bg-indigo-500 text-white px-4 py-2 text-sm font-medium hover:bg-indigo-700 dark:hover:bg-indigo-600 active:translate-y-px">
                <span>Ask</span>
                <svg id="askSpin" class="hidden animate-spin h-4 w-4" viewBox="0 0 24 24" fill="none">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v3a5 5 0 00-5 5H4z"></path>
                </svg>
              </button>
            </div>

            <div id="status" class="text-sm text-gray-600 dark:text-neutral-400"></div>
          </div>
        </section>

        <!-- answer -->
        <section id="answerBox" class="hidden bg-white dark:bg-neutral-900 rounded-2xl shadow-sm ring-1 ring-gray-200 dark:ring-neutral-800 p-5">
          <h3 class="text-base font-semibold mb-2">Answer</h3>
          <div id="answer" class="prose prose-sm dark:prose-invert max-w-none whitespace-pre-wrap leading-relaxed"></div>
        </section>

        <!-- snippets -->
        <section id="snipsBox" class="hidden bg-white dark:bg-neutral-900 rounded-2xl shadow-sm ring-1 ring-gray-200 dark:ring-neutral-800 p-5">
          <h3 class="text-base font-semibold mb-3">Retrieved snippets</h3>
          <div id="snips" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
        </section>

        <!-- citations -->
        <section id="citesBox" class="hidden bg-white dark:bg-neutral-900 rounded-2xl shadow-sm ring-1 ring-gray-200 dark:ring-neutral-800 p-5">
          <h3 class="text-base font-semibold mb-2">Citations</h3>
          <ul id="cites" class="space-y-1 text-sm text-gray-800 dark:text-neutral-200"></ul>
        </section>
      </div>
    </div>

    <!-- footer -->
    <footer class="mt-10 text-xs text-gray-500 dark:text-neutral-500">
      <div>Note: generation uses your server-side API key when enabled. Retrieved snippets always reflect your local index.</div>
    </footer>
  </div>

  <script>
    /* ------------ theme toggle ------------ */
    document.getElementById('themeBtn').addEventListener('click', () => {
      const root = document.documentElement;
      const isDark = root.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });

    /* ------------ drag & drop styling ------------ */
    const dropZone = document.getElementById('dropZone');
    const pdfInput = document.getElementById('pdfs');
    ;['dragenter','dragover'].forEach(evt =>
      dropZone.addEventListener(evt, (e)=>{ e.preventDefault(); dropZone.classList.add('border-indigo-400','dark:border-indigo-500','bg-indigo-50/40','dark:bg-indigo-500/5'); })
    );
    ;['dragleave','drop'].forEach(evt =>
      dropZone.addEventListener(evt, (e)=>{ e.preventDefault(); dropZone.classList.remove('border-indigo-400','dark:border-indigo-500','bg-indigo-50/40','dark:bg-indigo-500/5'); })
    );
    dropZone.addEventListener('drop', (e) => {
      const files = Array.from(e.dataTransfer.files || []).filter(f => f.type === 'application/pdf');
      if (files.length) {
        pdfInput.files = fileListFromArray(files);
        pdfInput.dispatchEvent(new Event('change')); // update label
      }
    });
    function fileListFromArray(array) {
      const dt = new DataTransfer();
      array.forEach(f => dt.items.add(f));
      return dt.files;
    }

    /* ------------ selected files label ------------ */
    const chosen = document.getElementById('chosen');

    function updateChosenLabel() {
      const files = Array.from(pdfInput.files || []);
      if (!files.length) { chosen.innerHTML = ''; return; }
      // show each file as a chip
      chosen.innerHTML = files.map(f =>
        `<span class="inline-block mr-1 mb-1 px-2 py-0.5 rounded-lg border text-[11px] border-gray-300 dark:border-neutral-700">
           ${escapeHtml(f.name)}
         </span>`
      ).join('');
    }
    pdfInput.addEventListener('change', updateChosenLabel);

    /* ------------ upload flow ------------ */
    document.getElementById('upBtn').addEventListener('click', async () => {
      const files = Array.from(pdfInput.files || []);
      if (!files.length) { toast('Choose one or more PDFs first'); return; }
      for (const f of files) await startUpload(f);
    });

    async function startUpload(file) {
      const jobs = document.getElementById('jobs');
      const row = document.createElement('div');
      row.className = 'rounded-xl border border-gray-200 dark:border-neutral-800 bg-gray-50 dark:bg-neutral-950/40 p-3';
      row.innerHTML = `
        <div class="flex justify-between items-center">
          <div class="truncate pr-2 text-sm font-medium">${escapeHtml(file.name)}</div>
          <div class="text-xs text-gray-500 dark:text-neutral-400" id="st">queued</div>
        </div>
        <div class="w-full bg-gray-200/70 dark:bg-neutral-800 rounded h-2 mt-2 overflow-hidden">
          <div id="bar" class="bg-indigo-600 dark:bg-indigo-500 h-2 rounded transition-all" style="width:0%"></div>
        </div>`;
      jobs.prepend(row);
      const st = row.querySelector('#st');
      const bar = row.querySelector('#bar');

      try {
        const fd = new FormData(); fd.append('file', file);
        const res = await fetch('/api/upload', { method:'POST', body: fd });
        if (!res.ok) throw new Error(await res.text() || ('http ' + res.status));
        const { job_id } = await res.json();

        let done = false;
        while (!done) {
          await sleep(900);
          const jr = await fetch(`/api/jobs/${job_id}`);
          if (!jr.ok) { st.textContent = 'job not found'; break; }
          const j = await jr.json();
          st.textContent = (j.step || j.status);
          bar.style.width = `${j.progress || 0}%`;
          if (j.status === 'done') {
            st.textContent = `done â€¢ ${j.message || ''}`;
            bar.style.width = '100%';
            toast('Indexed: ' + (file.name || 'document'));
            done = true;
            try { await loadDocs(); } catch {}
          }
          if (j.status === 'error') {
            st.textContent = `error â€¢ ${j.message || ''}`;
            bar.classList.add('bg-red-500');
            toast('Error indexing: ' + (j.message || ''), true);
            done = true;
          }
        }
      } catch (e) {
        st.textContent = 'error â€¢ ' + e.message;
        bar.classList.add('bg-red-500');
      }
    }

    /* ------------ docs list (calls /api/docs) ------------ */
    async function loadDocs() {
      const list = document.getElementById('docsList');
      const empty = document.getElementById('docsEmpty');
      list.innerHTML = '';
      empty.classList.add('hidden');

      try {
        const r = await fetch('/api/docs');
        if (!r.ok) throw new Error(await r.text());
        const { docs } = await r.json();

        if (!docs || !docs.length) {
          empty.classList.remove('hidden');
          return;
        }

        docs.forEach(d => {
          const row = document.createElement('div');
          row.className = 'py-2 flex items-center justify-between';
          row.innerHTML = `
            <div class="min-w-0">
              <div class="text-sm font-medium truncate">${escapeHtml(d.doc_id)}</div>
              <div class="text-xs text-gray-500 dark:text-neutral-400">
                ${escapeHtml(d.filename)} â€¢ ${d.num_chunks} chunk${d.num_chunks===1?'':'s'} â€¢ TEI: ${d.has_tei ? 'yes' : 'no'}
                ${d.modified_at ? ' â€¢ ' + escapeHtml(d.modified_at) : ''}
              </div>
            </div>
            <span class="text-[11px] px-2 py-0.5 rounded-full 
              ${d.num_chunks>0 ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300' : 'bg-gray-100 text-gray-700 dark:bg-neutral-800 dark:text-neutral-300'}">
              ${d.num_chunks>0 ? 'indexed' : 'pending'}
            </span>
          `;
          list.appendChild(row);
        });
      } catch (e) {
        console.error('loadDocs failed', e);
        toast('Failed to load documents: ' + e.message, true);
      }
    }

    document.getElementById('refreshDocs')?.addEventListener('click', loadDocs);
    document.addEventListener('DOMContentLoaded', () => {
      loadDocs();
      updateChosenLabel(); // initialize label if browser persisted selection
    });

    /* ------------ health ------------ */
    document.getElementById('healthBtn').addEventListener('click', async () => {
      const el = document.getElementById('health');
      el.textContent = 'checkingâ€¦';
      try {
        const r = await fetch('/api/health');
        const j = await r.json();
        el.textContent = `index: ${j.num_chunks} chunks â€¢ gemini: ${j.gemini ? 'ready' : 'off'}`;
      } catch {
        el.textContent = 'health check failed';
      }
    });

    /* ------------ ask flow ------------ */
    const askBtn = document.getElementById('askBtn');
    const askSpin = document.getElementById('askSpin');
    askBtn.addEventListener('click', ask);
    document.getElementById('q').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) ask();
    });

    async function ask() {
      const q = document.getElementById('q').value.trim();
      if (!q) { toast('Type a question first'); return; }
      const k = parseInt(document.getElementById('k').value || '40', 10);
      const perDoc = parseInt(document.getElementById('perDoc').value || '2', 10);
      const useGen = document.getElementById('useGen').checked;

      setStatus('Askingâ€¦');
      toggleSections(false);
      askBtn.disabled = true; askSpin.classList.remove('hidden');

      try {
        const res = await fetch('/api/ask', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ question: q, k: k, per_doc_cap: perDoc, generate: useGen })
        });
        if (!res.ok) throw new Error(await res.text() || ('http ' + res.status));
        const data = await res.json();
        render(data);
        setStatus('Done');
      } catch (e) {
        setStatus('Error: ' + e.message);
        toast('Ask failed: ' + e.message, true);
      } finally {
        askBtn.disabled = false; askSpin.classList.add('hidden');
      }
    }

    /* ------------ render helpers ------------ */
    function setStatus(msg) { document.getElementById('status').textContent = msg || ''; }
    function toggleSections(show) {
      document.getElementById('answerBox').classList.toggle('hidden', !show);
      document.getElementById('snipsBox').classList.toggle('hidden', !show);
      document.getElementById('citesBox').classList.toggle('hidden', !show);
    }
    function render(data) {
      // answer
      const ans = document.getElementById('answer');
      ans.textContent = data.generated ? (data.answer || '') : '(generation disabled or unavailable)';

      // snippets
      const snips = document.getElementById('snips'); snips.innerHTML = '';
      (data.snippets || []).forEach(s => {
        const el = document.createElement('div');
        el.className = 'rounded-xl border border-gray-200 dark:border-neutral-800 bg-white dark:bg-neutral-900 p-3';
        el.innerHTML = `
          <div class="flex items-center justify-between mb-1">
            <div class="text-sm font-medium">${escapeHtml(s.title)}</div>
            <div class="text-[11px] text-gray-500 dark:text-neutral-400">${escapeHtml(s.doc)}:${escapeHtml(s.chunk_id)} Â· cos=${s.score?.toFixed ? s.score.toFixed(3) : s.score}</div>
          </div>
          <div class="text-sm text-gray-700 dark:text-neutral-200 leading-relaxed">${escapeHtml(s.preview)}â€¦</div>`;
        snips.appendChild(el);
      });

      // citations
      const cites = document.getElementById('cites'); cites.innerHTML = '';
      (data.citations || []).forEach(c => {
        const li = document.createElement('li');
        li.className = 'marker:text-indigo-600 dark:marker:text-indigo-400';
        li.textContent = `${c.title} (source: ${c.doc})`;
        cites.appendChild(li);
      });

      toggleSections(true);
    }

    /* ------------ utilities ------------ */
    function escapeHtml(s) {
      return (s || '').replace(/[&<>"']/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }
    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    // tiny toast
    function toast(msg, isError=false) {
      const t = document.createElement('div');
      t.className = `fixed bottom-5 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded-xl shadow-lg text-sm
        ${isError ? 'bg-red-600 text-white' : 'bg-gray-900 text-white dark:bg-white dark:text-gray-900'}`;
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(()=>{ t.classList.add('opacity-0','translate-y-1','transition'); }, 2200);
      setTimeout(()=>{ t.remove(); }, 2800);
    }
  </script>
</body>
</html>
